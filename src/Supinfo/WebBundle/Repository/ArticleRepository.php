<?php

namespace Supinfo\WebBundle\Repository;

/**
 * ArticleRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ArticleRepository extends EntityRepository
{

    public function checkArticleFieldValues(\Supinfo\WebBundle\Entity\Article $article)
    {
        // Add missing fieldValues
        foreach ($article->getSubFamily()->getFields() as $field) {
            foreach ($article->getFieldValues() as $fieldValue) {
                if ($fieldValue->getSubFamilyField() == $field) {
                    break 2;
                }
            }

            $options = array(
                'subFamilyField' => $field,
                'article' => $article,
            );
            $newFieldValue = new \Supinfo\WebBundle\Entity\SubFamilyFieldValue($options);

            $article->getFieldValues()->add($newFieldValue);
        }

        // We have to remove the field values corresponding to the wrong subFamily.
        foreach ($article->getFieldValues() as $fieldValue) {
            if ($fieldValue->getSubFamilyField()->getSubFamily() != $article->getSubFamily()) {
                $article->getFieldValues()->removeElement($fieldValue);
                $this->getEntityManager()->remove($fieldValue);
            }
        }
    }

    public function selectQB()
    {
        $qb = parent::selectQB();

        $qb->addSelect(
            'sf'
        )->innerJoin(
            $this->getAlias().'.subFamily',
            'sf'
        );

        $qb->addSelect(
            'sff'
        )->leftJoin(
            'sf.fields',
            'sff'
        );

        $qb->addSelect(
            'fv'
        )->leftJoin(
            $this->getAlias().'.fieldValues',
            'fv'
        );

        return $qb;
    }

}